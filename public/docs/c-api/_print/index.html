<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.80.0" /><link rel="canonical" type="text/html" href="/docs/c-api/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/c-api/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>C API | Apache Avro</title>


  
  <meta name="description" content="The current version of Avro is 1.10.2. The current version of libavro is 23:0:0. This document was created 2021-10-21.
1. Introduction to Avro
Avro is …">
<meta property="og:title" content="C API" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/c-api/" />
<meta property="og:site_name" content="Apache Avro" />
<meta itemprop="name" content="C API">
<meta itemprop="description" content="">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="C API"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/scss/main.min.30d73e35c90f654c060d7e7add9a2e7c0ba6dad30372ff7416b222681b7b4652.css" as="style">
<link href="/scss/main.min.30d73e35c90f654c060d7e7add9a2e7c0ba6dad30372ff7416b222681b7b4652.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>









  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Apache Avro</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/project/" ><span>Project</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>Community</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.bd7e2231bf63166411990b06b1792b3f.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/c-api/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">C API</h1>





    <ul>
    
  
  
  
  

  

    </ul>


<div class="content">
      <p>The current version of Avro is 1.10.2. The current version of <code>libavro</code> is <code>23:0:0</code>. This document was created 2021-10-21.</p>
<h2 id="1-introduction-to-avro">1. Introduction to Avro</h2>
<p>Avro is a data serialization system.</p>
<p>Avro provides:</p>
<ul>
<li>Rich data structures.</li>
<li>A compact, fast, binary data format.</li>
<li>A container file, to store persistent data.</li>
<li>Remote procedure call (RPC).</li>
</ul>
<p>This document will focus on the C implementation of Avro. To learn more about Avro in general, visit the <a href="/">Avro website</a>.</p>
<h2 id="2-introduction-to-avro-c">2. Introduction to Avro C</h2>
<pre><code>    ___                      ______
   /   |_   ___________     / ____/
  / /| | | / / ___/ __ \   / /
 / ___ | |/ / /  / /_/ /  / /___
/_/  |_|___/_/   \____/   \____/
</code></pre><blockquote>
<p>A C program is like a fast dance on a newly waxed dance floor by people carrying razors. — Waldi Ravens</p>
</blockquote>
<p>The C implementation has been tested on MacOSX and Linux but, over time, the number of support OSes should grow. Please let us know if you’re using <code>Avro C</code> on other systems.</p>
<p>Avro depends on the <a href="http://www.digip.org/jansson/">Jansson JSON parser</a>, version 2.3 or higher. On many operating systems this library is available through your package manager (for example, <code>apt-get install libjansson-dev</code> on Ubuntu/Debian, and <code>brew install jansson</code> on Mac OS). If not, please download and install it from source.</p>
<p>The C implementation supports:</p>
<ul>
<li>binary encoding/decoding of all primitive and complex data types</li>
<li>storage to an Avro Object Container File</li>
<li>schema resolution, promotion and projection</li>
<li>validating and non-validating mode for writing Avro data</li>
</ul>
<p>The C implementation is lacking:</p>
<ul>
<li>RPC</li>
</ul>
<p>To learn about the API, take a look at the examples and reference files later in this document.</p>
<p>We’re always looking for contributions so, if you’re a C hacker, please feel free to [submit patches to the project](TODO link to HOW TO CONTRIBUTE).</p>
<h2 id="3-error-reporting">3. Error reporting</h2>
<p>Most functions in the Avro C library return a single int status code. Following the POSIX <code>errno.h</code> convention, a status code of 0 indicates success. Non-zero codes indiciate an error condition. Some functions return a pointer value instead of an int status code; for these functions, a NULL pointer indicates an error.</p>
<p>You can retrieve a string description of the most recent error using the avro_strerror function:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_schema_t</span>  <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error was %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="4-avro-values">4. Avro values</h2>
<p>Starting with version 1.6.0, the Avro C library has a new API for handling Avro data. To help distinguish between the two APIs, we refer to the old one as the <code>legacy</code> or <code>datum</code> API, and the new one as the <code>value</code> API. (These names come from the names of the C types used to represent Avro data in the corresponding API — <code>avro_datum_t</code> and <code>avro_value_t</code>.) The legacy API is still present, but it’s deprecated — you shouldn’t use the <code>avro_datum_t</code> type or the avro_datum_* functions in new code.</p>
<p>One main benefit of the new value API is that you can treat any existing C type as an Avro value; you just have to provide a custom implementation of the value interface. In addition, we provide a generic value implementation; “generic”, in this sense, meaning that this single implementation works for instances of any Avro schema type. Finally, we also provide a wrapper implementation for the deprecated avro_datum_t type, which lets you gradually transition to the new value API.</p>
<h3 id="41-avro-value-interface">4.1. Avro value interface</h3>
<p>You interact with Avro values using the value interface, which defines methods for setting and retrieving the contents of an Avro value. An individual value is represented by an instance of the avro_value_t type.</p>
<p>This section provides an overview of the methods that you can call on an avro_value_t instance. There are quite a few methods in the value interface, but not all of them make sense for all Avro schema types. For instance, you won’t be able to call avro_value_set_boolean on an Avro array value. If you try to call an inappropriate method, we’ll return an EINVAL error code.</p>
<p>Note that the functions in this section apply to all Avro values, regardless of which value implementation is used under the covers. This section doesn’t describe how to create value instances, since those constructors will be specific to a particular value implementation.</p>
<h4 id="411-common-methods">4.1.1. Common methods</h4>
<p>There are a handful of methods that can be used with any value, regardless of which Avro schema it’s an instance of:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdint.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">avro_type_t</span> <span style="color:#000">avro_value_get_type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_schema_t</span> <span style="color:#000">avro_value_get_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v2</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_equal_fast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v2</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_copy_fast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">uint32_t</span> <span style="color:#000">avro_value_hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_reset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The <code>get_type</code> and <code>get_schema</code> methods can be used to get information about what kind of Avro value a given avro_value_t instance represents. (For <code>get_schema</code>, you borrow the value’s reference to the schema; if you need to save it and ensure that it outlives the value, you need to call avro_schema_incref on it.)</p>
<p>The <code>equal</code> and <code>equal_fast</code> methods compare two values for equality. The two values do not have to have the same value implementations, but they do have to be instances of the same schema. (Not equivalent schemas; the same schema.) The equal method checks that the schemas match; the equal_fast method assumes that they do.</p>
<p>The copy and copy_fast methods copy the contents of one Avro value into another. (Where possible, this is done without copying the actual content of a bytes, string, or fixed value, using the avro_wrapped_buffer_t functions described in the next section.) Like equal, the two values must have the same schema; copy checks this, while copy_fast assumes it.</p>
<p>The hash method returns a hash value for the given Avro value. This can be used to construct hash tables that use Avro values as keys. The function works correctly even with maps; it produces a hash that doesn’t depend on the ordering of the elements of the map. Hash values are only meaningful for comparing values of exactly the same schema. Hash values are not guaranteed to be consistent across different platforms, or different versions of the Avro library. That means that it’s really only safe to use these hash values internally within the context of a single execution of a single application.</p>
<p>The reset method “clears out” an +avro_value_t instance, making sure that it’s ready to accept the contents of a new value. For scalars, this is usually a no-op, since the new value will just overwrite the old one. For arrays and maps, this removes any existing elements from the container, so that we can append the elements of the new value. For records and unions, this just recursively resets the fields or current branch.</p>
<h4 id="412-scalar-values">4.1.2. Scalar values</h4>
<p>The simplest case is handling instances of the scalar Avro schema types. In Avro, the scalars are all of the primitive schema types, as well as enum and fixed — i.e., anything that can’t contain another Avro value. Note that we use standard C99 types to represent the primitive contents of an Avro scalar.</p>
<p>To retrieve the contents of an Avro scalar, you can use one of the getter methods:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdint.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_boolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_long</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int64_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                          <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_enum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>For the most part, these should be self-explanatory. For bytes, string, and fixed values, the pointer to the underlying content is const — you aren’t allowed to modify the contents directly. We guarantee that the content of a string will be NUL-terminated, so you can use it as a C string as you’d expect. The size returned for a string object will include the NUL terminator; it will be one more than you’d get from calling strlen on the content.</p>
<p>Also, for bytes, string, and fixed, the dest and size parameters are optional; if you only want to determine the length of a bytes value, you can use:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_value_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* from somewhere */</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">size_t</span>  <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">avro_value_get_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>To set the contents of an Avro scalar, you can use one of the setter methods:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdint.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_boolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32_t</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_long</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int64_t</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_string_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                              <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_enum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>These are also straightforward. For bytes, string, and fixed values, the set methods will make a copy of the underlying data. For string values, the content must be NUL-terminated. You can use set_string_len if you already know the length of the string content; the length you pass in should include the NUL terminator. If you call set_string, then we’ll use strlen to calculate the length.</p>
<p>For fixed values, the size must match what’s expected by the value’s underlying fixed schema; if the sizes don’t match, you’ll get an error code.</p>
<p>If you don’t want to copy the contents of a bytes, string, or fixed value, you can use the giver and grabber functions:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdint.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">avro_buf_free_t</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">user_data</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_give_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_give_string_len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_give_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_grab_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_grab_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_grab_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">avro_wrapped_buffer</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">size_t</span>  <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">free</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">self</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">size_t</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">self</span><span style="color:#000;font-weight:bold">,</span>
                 <span style="color:#000">size_t</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#000">avro_wrapped_buffer_t</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">void</span>
<span style="color:#000">avro_wrapped_buffer_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span>
<span style="color:#000">avro_wrapped_buffer_copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#000">size_t</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">int</span>
<span style="color:#000">avro_wrapped_buffer_slice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_wrapped_buffer_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">self</span><span style="color:#000;font-weight:bold">,</span>
                          <span style="color:#000">size_t</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The <code>give</code> functions give control of an existing buffer to the value. (You should not try to free the src wrapped buffer after calling this method.) The grab function fills in a wrapped buffer with a pointer to the contents of an Avro value. (You should free the dest wrapped buffer when you’re done with it.)</p>
<p>The avro_wrapped_buffer_t struct encapsulates the location and size of the existing buffer. It also includes several methods. The free method will be called when the content of the buffer is no longer needed. The slice method will be called when the wrapped buffer needs to be updated to point at a subset of what it pointed at before. (This doesn’t create a new wrapped buffer; it updates an existing one.) The copy method will be called if the content needs to be copied. Note that if you’re wrapping a buffer with nice reference counting features, you don’t need to perform an actual copy; you just need to ensure that the free function can be called on both the original and the copy, and not have things blow up.</p>
<p>The “generic” value implementation takes advantage of this feature; if you pass in a wrapped buffer with a give method, and then retrieve it later with a grab method, then we’ll use the wrapped buffer’s copy method to fill in the dest parameter. If your wrapped buffer implements a slice method that updates reference counts instead of actually copying, then you’ve got nice zero-copy access to the contents of an Avro value.</p>
<h4 id="413-compound-values">4.1.3. Compound values</h4>
<p>The following sections describe the getter and setter methods for handling compound Avro values. All of the compound values are responsible for the storage of their children; this means that there isn’t a method, for instance, that lets you add an existing avro_value_t to an array. Instead, there’s a method that creates a new, empty avro_value_t of the appropriate type, adds it to the array, and returns it for you to fill in as needed.</p>
<p>You also shouldn’t try to free the child elements that are created this way; the container value is responsible for their life cycle. The child element is guaranteed to be valid for as long as the container value is. You’ll usually define an avro_value_t in the stack, and let it fall out of scope when you’re done with it:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_value_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* from somewhere else */</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">avro_value_t</span>  <span style="color:#000">child</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">avro_value_get_by_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">child</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">/* do something interesting with the array element */</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="414-arrays">4.1.4. Arrays</h4>
<p>There are three methods that can be used with array values:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_by_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span>
                            <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">unused</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span>
                      <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">new_index</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The get_size method returns the number of elements currently in the array. The get_by_index method fills in element to point at the array element with the given index. (You should use NULL for the unused parameter; it’s ignored for array values.)</p>
<p>The append method creates a new value, appends it to the array, and returns it in element. If new_index is given, then it will be filled in with the index of the new element.</p>
<h4 id="415-maps">4.1.5. Maps</h4>
<p>There are four methods that can be used with map values:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
                           <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_by_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span>
                            <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span>
                   <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span>
                   <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">is_new</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The get_size method returns the number of elements currently in the map. Map elements can be retrieved either by their key (get_by_name) or by their numeric index (get_by_index). (Numeric indices in a map are based on the order that the elements were added to the map.) In either case, the method takes in an optional output parameter that let you retrieve the index associated with a key, and vice versa.</p>
<p>The add method will add a new value to the map, if the given key isn’t already present. If the key is present, then the existing value with be returned. The index parameter, if given, will be filled in the element’s index. The is_new parameter, if given, can be used to determine whether the mapped value is new or not.</p>
<h4 id="416-records">4.1.6. Records</h4>
<p>There are three methods that can be used with record values:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">record</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_by_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">record</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span>
                            <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">record</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">,</span>
                           <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The get_size method returns the number of fields in the record. (You can also get this by querying the value’s schema, but for some implementations, this method can be faster.)</p>
<p>The get_by_index and get_by_name functions can be used to retrieve one of the fields in the record, either by its ordinal position within the record, or by the name of the underlying field. Like with maps, the methods take in an additional parameter that let you retrieve the index associated with a field name, and vice versa.</p>
<p>When possible, it’s recommended that you access record fields by their numeric index, rather than by their field name. For most implementations, this will be more efficient.</p>
<h4 id="417-unions">4.1.7. Unions</h4>
<p>There are three methods that can be used with union values:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">union_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">disc</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_get_current_branch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">union_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">branch</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_value_set_branch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">union_val</span><span style="color:#000;font-weight:bold">,</span>
                          <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">discriminant</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">branch</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The get_discriminant and get_current_branch methods return the current state of the union value, without modifying which branch is currently selected. The set_branch method can be used to choose the active branch, filling in the branch value to point at the branch’s value instance. (Most implementations will be smart enough to detect when the desired branch is already selected, so you should always call this method unless you can guarantee that the right branch is already current.)</p>
<h3 id="42-creating-value-instances">4.2. Creating value instances</h3>
<p>Okay, so we’ve described how to interact with a value that you already have a pointer to, but how do you create one in the first place? Each implementation of the value interface must provide its own functions for creating avro_value_t instances for that class. The 10,000-foot view is to:</p>
<p>Get an implementation struct for the value implementation that you want to use. (This is represented by an avro_value_iface_t pointer.)</p>
<p>Use the implementation’s constructor function to allocate instances of that value implementation.</p>
<p>Do whatever you need to the value (using the avro_value_t methods described in the previous section).</p>
<p>Free the value instance, if necessary, using the implementation’s destructor function.</p>
<p>Free the implementation struct when you’re done creating value instances.</p>
<p>These steps use the following functions:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">avro_value_iface_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">avro_value_iface_incref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_iface_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iface</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">avro_value_iface_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_iface_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iface</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Note that for most value implementations, it’s fine to reuse a single avro_value_t instance for multiple values, using the avro_value_reset function before filling in the instance for each value. (This helps reduce the number of malloc and free calls that your application will make.)</p>
<p>We provide a “generic” value implementation that will work (efficiently) for any Avro schema.</p>
<p>For most applications, you won’t need to write your own value implementation; the Avro C library provides an efficient “generic” implementation, which supports the full range of Avro schema types. There’s a good chance that you just want to use this implementation, rather than rolling your own. (The primary reason for rolling your own would be if you want to access the elements of a compound value using C syntax — for instance, translating an Avro record into a C struct.) You can use the following functions to create and work with a generic value implementation for a particular schema:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">avro_value_iface_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">avro_generic_class_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_generic_value_new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avro_value_iface_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">avro_generic_value_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">self</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Combining all of this together, you might have the following snippet of code:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_schema_t</span>  <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_long</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">avro_value_iface_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iface</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_generic_class_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">avro_value_t</span>  <span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">avro_generic_value_new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">iface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">/* Generate Avro longs from 0-499 */</span>
<span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">avro_value_reset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">avro_value_set_long</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">/* do something with the value */</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">avro_generic_value_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_value_iface_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">iface</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="5-reference-counting">5. Reference Counting</h2>
<p>Avro C does reference counting for all schema and data objects. When the number of references drops to zero, the memory is freed.</p>
<p>For example, to create and free a string, you would use:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_datum_t</span> <span style="color:#000">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;This is my string&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Things get a little more complicated when you consider more elaborate schema and data structures.</p>
<p>For example, let’s say that you create a record with a single string field:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_datum_t</span> <span style="color:#000">example</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Example&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_datum_t</span> <span style="color:#000">solo_field</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Example field value&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">avro_record_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">example</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;solo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">solo_field</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">example</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>In this example, the solo_field datum would not be freed since it has two references: the original reference and a reference inside the Example record. The avro_datum_decref(example) call drops the number of reference to one. If you are finished with the solo_field schema, then you need to avro_schema_decref(solo_field) to completely dereference the solo_field datum and free it.</p>
<h2 id="6-wrap-it-and-give-it">6. Wrap It and Give It</h2>
<p>You’ll notice that some datatypes can be &ldquo;wrapped&rdquo; and &ldquo;given&rdquo;. This allows C programmers the freedom to decide who is responsible for the memory. Let’s take strings for example.</p>
<p>To create a string datum, you have three different methods:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">avro_datum_t</span> <span style="color:#000">avro_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_datum_t</span> <span style="color:#000">avro_wrapstring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">avro_datum_t</span> <span style="color:#000">avro_givestring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you use, avro_string then Avro C will make a copy of your string and free it when the datum is dereferenced. In some cases, especially when dealing with large amounts of data, you want to avoid this memory copy. That’s where avro_wrapstring and avro_givestring can help.</p>
<p>If you use, avro_wrapstring then Avro C will do no memory management at all. It will just save a pointer to your data and it’s your responsibility to free the string.</p>
<p>Warning
When using avro_wrapstring, do not free the string before you dereference the string datum with avro_datum_decref().
Lastly, if you use avro_givestring then Avro C will free the string later when the datum is dereferenced. In a sense, you are &ldquo;giving&rdquo; responsibility for freeing the string to Avro C.</p>
<p>Warning
Don’t &ldquo;give&rdquo; Avro C a string that you haven’t allocated from the heap with e.g. malloc or strdup.</p>
<p>For example, don’t do this:</p>
<p>avro_datum_t bad_idea = avro_givestring(&ldquo;This isn&rsquo;t allocated on the heap&rdquo;);</p>
<h2 id="7-schema-validation">7. Schema Validation</h2>
<p>If you want to write a datum, you would use the following function</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">avro_write_data</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_writer_t</span> <span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span>
                    <span style="color:#000">avro_schema_t</span> <span style="color:#000">writers_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you pass in a writers_schema, then you datum will be validated before it is sent to the writer. This check ensures that your data has the correct format. If you are certain your datum is correct, you can pass a NULL value for writers_schema and Avro C will not validate before writing.</p>
<p>Note
Data written to an Avro File Object Container is always validated.</p>
<h2 id="8-examples">8. Examples</h2>
<p>I’m not even supposed to be here today!</p>
<p>— Dante Hicks
Imagine you’re a free-lance hacker in Leonardo, New Jersey and you’ve been approached by the owner of the local Quick Stop Convenience store. He wants you to create a contact database case he needs to call employees to work on their day off.</p>
<p>You might build a simple contact system using Avro C like the following…</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Licensed to the Apache Software Foundation (ASF) under one or more
</span><span style="color:#8f5902;font-style:italic"> * contributor license agreements.  See the NOTICE file distributed with
</span><span style="color:#8f5902;font-style:italic"> * this work for additional information regarding copyright ownership.
</span><span style="color:#8f5902;font-style:italic"> * The ASF licenses this file to you under the Apache License, Version 2.0
</span><span style="color:#8f5902;font-style:italic"> * (the &#34;License&#34;); you may not use this file except in compliance with
</span><span style="color:#8f5902;font-style:italic"> * the License.  You may obtain a copy of the License at
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#8f5902;font-style:italic"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#8f5902;font-style:italic"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
</span><span style="color:#8f5902;font-style:italic"> * implied.  See the License for the specific language governing
</span><span style="color:#8f5902;font-style:italic"> * permissions and limitations under the License.
</span><span style="color:#8f5902;font-style:italic"> */</span>

<span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">#ifdef DEFLATE_CODEC
</span><span style="color:#8f5902;font-style:italic">#define QUICKSTOP_CODEC  &#34;deflate&#34;
</span><span style="color:#8f5902;font-style:italic">#else
</span><span style="color:#8f5902;font-style:italic">#define QUICKSTOP_CODEC  &#34;null&#34;
</span><span style="color:#8f5902;font-style:italic">#endif
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">avro_schema_t</span> <span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">int64_t</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">/* A simple schema for our tutorial */</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>  <span style="color:#000">PERSON_SCHEMA</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span>
<span style="color:#4e9a06">&#34;{</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">record</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">,\
</span><span style="color:#4e9a06">  </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Person</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">,\
</span><span style="color:#4e9a06">  </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">fields</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">:[\
</span><span style="color:#4e9a06">     {</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">ID</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">long</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">},\
</span><span style="color:#4e9a06">     {</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">First</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">string</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">},\
</span><span style="color:#4e9a06">     {</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Last</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">string</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">},\
</span><span style="color:#4e9a06">     {</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Phone</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">string</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">},\
</span><span style="color:#4e9a06">     {</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Age</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">int</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">}]}&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">/* Parse schema into a schema data structure */</span>
<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">init_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_schema_from_json_literal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PERSON_SCHEMA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unable to parse person schema</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/* Create a value to match the person schema and save it */</span>
<span style="color:#204a87;font-weight:bold">void</span>
<span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_file_writer_t</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">last</span><span style="color:#000;font-weight:bold">,</span>
           <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">phone</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32_t</span> <span style="color:#000">age</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_value_iface_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">person_class</span> <span style="color:#ce5c00;font-weight:bold">=</span>
            <span style="color:#000">avro_generic_class_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_value_t</span>  <span style="color:#000">person</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_generic_value_new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_class</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_value_t</span> <span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_value_t</span> <span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_value_t</span> <span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_value_t</span> <span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_value_t</span> <span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_value_set_long</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;First&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_value_set_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Last&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_value_set_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">last</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_value_set_int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">age</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Phone&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_value_set_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">phone</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_file_writer_append_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#4e9a06">&#34;Unable to write Person value to memory buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Message: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">/* Decrement all our references to prevent memory from leaking */</span>
        <span style="color:#000">avro_value_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_value_iface_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_class</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">print_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_file_reader_t</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_t</span> <span style="color:#000">reader_schema</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>

        <span style="color:#000">avro_value_iface_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">person_class</span> <span style="color:#ce5c00;font-weight:bold">=</span>
            <span style="color:#000">avro_generic_class_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_value_t</span> <span style="color:#000">person</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_generic_value_new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_class</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">rval</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">rval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_file_reader_read_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">int64_t</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">int32_t</span> <span style="color:#000">age</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">int32_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_value_t</span> <span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_value_t</span> <span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_value_t</span> <span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_value_t</span> <span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_value_t</span> <span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">;</span>

                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">avro_value_get_long</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">id_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%&#34;</span><span style="color:#000">PRId64</span><span style="color:#4e9a06">&#34; | &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;First&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">avro_value_get_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">first_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%15s | &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Last&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">avro_value_get_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">last_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%15s | &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Phone&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">avro_value_get_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">phone_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%15s | &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_value_get_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">avro_value_get_int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%&#34;</span><span style="color:#000">PRId32</span><span style="color:#4e9a06">&#34; | &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">age</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>

                <span style="color:#8f5902;font-style:italic">/* We no longer need this memory */</span>
                <span style="color:#000">avro_value_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_value_iface_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_class</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rval</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">rval</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_file_reader_t</span> <span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_file_writer_t</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">projection_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">first_name_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">phone_schema</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">int64_t</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dbname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;quickstop.db&#34;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>

        <span style="color:#8f5902;font-style:italic">/* Initialize the schema structure from JSON */</span>
        <span style="color:#000">init_schema</span><span style="color:#000;font-weight:bold">();</span>

        <span style="color:#8f5902;font-style:italic">/* Delete the database if it exists */</span>
        <span style="color:#000">remove</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#8f5902;font-style:italic">/* Create a new database */</span>
        <span style="color:#000">rval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_file_writer_create_with_codec</span>
            <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">QUICKSTOP_CODEC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;There was an error creating %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34; error message: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">/* Add lots of people to the database */</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Dante&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Hicks&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Randal&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Graves&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(555) 123-5678&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Veronica&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Loughran&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(555) 123-0987&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Caitlin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Bree&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(555) 123-2323&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Bob&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Silent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(555) 123-6422&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">29</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Jay&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;???&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">/* Close the block and open a new one */</span>
        <span style="color:#000">avro_file_writer_flush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">add_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Super&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Man&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_file_writer_close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Now let&#39;s read all the records back out</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">/* Read all the records and print them */</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_file_reader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error opening file: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error printing person</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Message: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">avro_file_reader_close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">/* You can also use projection, to only decode only the data you are
</span><span style="color:#8f5902;font-style:italic">           interested in.  This is particularly useful when you have
</span><span style="color:#8f5902;font-style:italic">           huge data sets and you&#39;ll only interest in particular fields
</span><span style="color:#8f5902;font-style:italic">           e.g. your contacts First name and phone number */</span>
        <span style="color:#000">projection_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Person&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">first_name_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">phone_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_record_field_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">projection_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;First&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                        <span style="color:#000">first_name_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_record_field_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">projection_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Phone&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                        <span style="color:#000">phone_schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">/* Read only the record you&#39;re interested in */</span>
        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n\n</span><span style="color:#4e9a06">Use projection to print only the First name and phone numbers</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_file_reader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error opening file: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_person</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projection_schema</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error printing person: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">avro_file_reader_close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dbreader</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">first_name_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">phone_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">projection_schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">/* We don&#39;t need this schema anymore */</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>When you compile and run this program, you should get the following output</p>
<pre><code>Successfully added Hicks, Dante id=1
Successfully added Graves, Randal id=2
Successfully added Loughran, Veronica id=3
Successfully added Bree, Caitlin id=4
Successfully added Silent, Bob id=5
Successfully added ???, Jay id=6
</code></pre><p>Avro is compact. Here is the data for all 6 people.</p>
<pre><code>| 02 0A 44 61 6E 74 65 0A | 48 69 63 6B 73 1C 28 35 |   ..Dante.Hicks.(5
| 35 35 29 20 31 32 33 2D | 34 35 36 37 40 04 0C 52 |   55) 123-4567@..R
| 61 6E 64 61 6C 0C 47 72 | 61 76 65 73 1C 28 35 35 |   andal.Graves.(55
| 35 29 20 31 32 33 2D 35 | 36 37 38 3C 06 10 56 65 |   5) 123-5678&lt;..Ve
| 72 6F 6E 69 63 61 10 4C | 6F 75 67 68 72 61 6E 1C |   ronica.Loughran.
| 28 35 35 35 29 20 31 32 | 33 2D 30 39 38 37 38 08 |   (555) 123-09878.
| 0E 43 61 69 74 6C 69 6E | 08 42 72 65 65 1C 28 35 |   .Caitlin.Bree.(5
| 35 35 29 20 31 32 33 2D | 32 33 32 33 36 0A 06 42 |   55) 123-23236..B
| 6F 62 0C 53 69 6C 65 6E | 74 1C 28 35 35 35 29 20 |   ob.Silent.(555)
| 31 32 33 2D 36 34 32 32 | 3A 0C 06 4A 61 79 06 3F |   123-6422:..Jay.?
| 3F 3F 1C 28 35 35 35 29 | 20 31 32 33 2D 39 31 38 |   ??.(555) 123-918
| 32 34 .. .. .. .. .. .. | .. .. .. .. .. .. .. .. |   24..............
</code></pre><p>Now let&rsquo;s read all the records back out
1 |           Dante |           Hicks |  (555) 123-4567 | 32
2 |          Randal |          Graves |  (555) 123-5678 | 30
3 |        Veronica |        Loughran |  (555) 123-0987 | 28
4 |         Caitlin |            Bree |  (555) 123-2323 | 27
5 |             Bob |          Silent |  (555) 123-6422 | 29
6 |             Jay |             ??? |  (555) 123-9182 | 26</p>
<p>Use projection to print only the First name and phone numbers
Dante |  (555) 123-4567 |
Randal |  (555) 123-5678 |
Veronica |  (555) 123-0987 |
Caitlin |  (555) 123-2323 |
Bob |  (555) 123-6422 |
Jay |  (555) 123-9182 |
The Quick Stop owner was so pleased, he asked you to create a movie database for his RST Video store.</p>
<h2 id="9-reference-files">9. Reference files</h2>
<h3 id="91-avroh">9.1. avro.h</h3>
<p>The avro.h header file contains the complete public API for Avro C. The documentation is rather sparse right now but we’ll be adding more information soon.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Licensed to the Apache Software Foundation (ASF) under one or more
</span><span style="color:#8f5902;font-style:italic"> * contributor license agreements.  See the NOTICE file distributed with
</span><span style="color:#8f5902;font-style:italic"> * this work for additional information regarding copyright ownership.
</span><span style="color:#8f5902;font-style:italic"> * The ASF licenses this file to you under the Apache License, Version 2.0
</span><span style="color:#8f5902;font-style:italic"> * (the &#34;License&#34;); you may not use this file except in compliance with
</span><span style="color:#8f5902;font-style:italic"> * the License.  You may obtain a copy of the License at
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#8f5902;font-style:italic"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#8f5902;font-style:italic"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
</span><span style="color:#8f5902;font-style:italic"> * implied.  See the License for the specific language governing
</span><span style="color:#8f5902;font-style:italic"> * permissions and limitations under the License.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#8f5902;font-style:italic">#ifndef AVRO_H
</span><span style="color:#8f5902;font-style:italic">#define AVRO_H
</span><span style="color:#8f5902;font-style:italic">#ifdef __cplusplus
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#4e9a06">&#34;C&#34;</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#8f5902;font-style:italic">#define CLOSE_EXTERN }
</span><span style="color:#8f5902;font-style:italic">#else
</span><span style="color:#8f5902;font-style:italic">#define CLOSE_EXTERN
</span><span style="color:#8f5902;font-style:italic">#endif
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/allocation.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/basics.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/consumer.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/data.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/errors.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/generic.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/io.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/legacy.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/platform.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/resolver.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/schema.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;avro/value.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">CLOSE_EXTERN</span>
<span style="color:#8f5902;font-style:italic">#endif
</span></code></pre></div><h3 id="92-test_avro_datac">9.2. test_avro_data.c</h3>
<p>Another good way to learn how to encode/decode data in Avro C is to look at the test_avro_data.c unit test. This simple unit test checks that all the avro types can be encoded/decoded correctly.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Licensed to the Apache Software Foundation (ASF) under one or more
</span><span style="color:#8f5902;font-style:italic"> * contributor license agreements.  See the NOTICE file distributed with
</span><span style="color:#8f5902;font-style:italic"> * this work for additional information regarding copyright ownership.
</span><span style="color:#8f5902;font-style:italic"> * The ASF licenses this file to you under the Apache License, Version 2.0
</span><span style="color:#8f5902;font-style:italic"> * (the &#34;License&#34;); you may not use this file except in compliance with
</span><span style="color:#8f5902;font-style:italic"> * the License.  You may obtain a copy of the License at
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#8f5902;font-style:italic"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#8f5902;font-style:italic"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
</span><span style="color:#8f5902;font-style:italic"> * implied.  See the License for the specific language governing
</span><span style="color:#8f5902;font-style:italic"> * permissions and limitations under the License.
</span><span style="color:#8f5902;font-style:italic"> */</span>

<span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;avro.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;avro_private.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;limits.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;time.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#000">avro_reader_t</span> <span style="color:#000">reader</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">avro_writer_t</span> <span style="color:#000">writer</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#000">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">avro_test</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * Use a custom allocator that verifies that the size that we use to
</span><span style="color:#8f5902;font-style:italic"> * free an object matches the size that we use to allocate it.
</span><span style="color:#8f5902;font-style:italic"> */</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span>
<span style="color:#000">test_allocator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ud</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">osize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size_t</span> <span style="color:#000">nsize</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">AVRO_UNUSED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ud</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">AVRO_UNUSED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">osize</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nsize</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">size_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">osize</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#4e9a06">&#34;Error freeing %p:</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
                                <span style="color:#4e9a06">&#34;Size passed to avro_free (%&#34;</span> <span style="color:#000">PRIsz</span> <span style="color:#4e9a06">&#34;) &#34;</span>
                                <span style="color:#4e9a06">&#34;doesn&#39;t match size passed to &#34;</span>
                                <span style="color:#4e9a06">&#34;avro_malloc (%&#34;</span> <span style="color:#000">PRIsz</span> <span style="color:#4e9a06">&#34;)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">osize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000">abort</span><span style="color:#000;font-weight:bold">();</span>
                        <span style="color:#8f5902;font-style:italic">//exit(EXIT_FAILURE);
</span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000">free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">size_t</span>  <span style="color:#000">real_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nsize</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">size_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">old_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr</span><span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ptr</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">size_t</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">realloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">old_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">real_size</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nsize</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">init_rand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">srand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">rand_number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">range</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">to</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">from</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">from</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">RAND_MAX</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1.0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">range</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">int64_t</span> <span style="color:#000">rand_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">int64_t</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">rand_number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LONG_MIN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LONG_MAX</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">int32_t</span> <span style="color:#000">rand_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">int32_t</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">rand_number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">INT_MIN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">INT_MAX</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">void</span>
<span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_schema_t</span> <span style="color:#000">writers_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                 <span style="color:#000">avro_schema_t</span> <span style="color:#000">readers_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_datum_t</span> <span style="color:#000">expected</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum_out</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">validate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">validate</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">validate</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

                <span style="color:#000">reader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_reader_memory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">));</span>
                <span style="color:#000">writer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_writer_memory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">));</span>

                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">expected</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>

                <span style="color:#8f5902;font-style:italic">/* Validating read/write */</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_write_data</span>
                    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">writers_schema</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unable to write %s validate=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">  %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000">int64_t</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">=</span>
                    <span style="color:#000">avro_size_data</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">writers_schema</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
                                   <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">avro_writer_tell</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#4e9a06">&#34;Unable to calculate size %s validate=%d &#34;</span>
                                <span style="color:#4e9a06">&#34;(%&#34;</span><span style="color:#000">PRId64</span><span style="color:#4e9a06">&#34; != %&#34;</span><span style="color:#000">PRId64</span><span style="color:#4e9a06">&#34;)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">  %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_writer_tell</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">),</span>
                                <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_read_data</span>
                    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">writers_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">readers_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">datum_out</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unable to read %s validate=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">  %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;  %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">avro_datum_equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum_out</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#4e9a06">&#34;Unable to encode/decode %s validate=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">  %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>

                <span style="color:#000">avro_reader_dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum_out</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_reader_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reader</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_writer_free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">expected</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">char</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">json</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_to_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">strcasecmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expected</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected JSON encoding: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">json</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;Four score and seven years ago&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#4e9a06">&#34;our father brought forth on this continent&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#4e9a06">&#34;a new nation&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;conceived in Liberty&#34;</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#4e9a06">&#34;and dedicated to the proposition that all men are created equal.&#34;</span>
        <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">writer_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givestring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givestring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Four score and seven years ago</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">// The following should bork if we don&#39;t copy the string value
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// correctly (since we&#39;ll try to free a static string).
</span><span style="color:#8f5902;font-style:italic"></span>
        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this should be copied&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_string_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;also this&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">0xDE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xAD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xBE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xEF</span> <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">writer_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_bytes</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givebytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;\\</span><span style="color:#4e9a06">u00de</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">u00ad</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">u00be</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">u00ef</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givebytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_givebytes_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">expected_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givebytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">avro_datum_equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#4e9a06">&#34;Expected equal bytes instances.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">// The following should bork if we don&#39;t copy the bytes value
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// correctly (since we&#39;ll try to free a static string).
</span><span style="color:#8f5902;font-style:italic"></span>
        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;original&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_bytes_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;alsothis&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">writer_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_int</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">long_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_long</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">float_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_float</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">double_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_double</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">int32_t</span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rand_int32</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">long_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">float_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">double_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">long_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">long_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;int-&gt;long&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">float_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">float_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;int-&gt;float&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;int-&gt;double&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">long_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">float_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">long_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">float_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">writer_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_long</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">float_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_float</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">double_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_double</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">int64_t</span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rand_int64</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">float_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">double_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;long&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">float_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">float_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;long-&gt;float&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;long-&gt;double&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">float_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;10000&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">float_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_double</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand_number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1.0E10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.0E10</span><span style="color:#000;font-weight:bold">));</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;double&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2000.0</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;2000.0&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_float</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">double_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_double</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">float</span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rand_number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1.0E10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.0E10</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">double_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_double</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;float&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                                 <span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;float-&gt;double&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_float</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2000.0</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;2000.0&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">double_schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_boolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">expected_json</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span> <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_boolean</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_boolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;boolean&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expected_json</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_null</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_null</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_null</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;person&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_record_field_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000">avro_schema_record_field_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_int</span><span style="color:#000;font-weight:bold">());</span>

        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">name_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">age_datum</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">name_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givestring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Joseph Campbell&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">age_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">83</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_record_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_record_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">age_datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;{</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Joseph Campbell</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">age</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 83}&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">rc</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_record_set_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">104</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">int32_t</span>  <span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_record_get_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">104</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Incorrect age value</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_nested_record</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">json</span> <span style="color:#ce5c00;font-weight:bold">=</span>
                <span style="color:#4e9a06">&#34;{&#34;</span>
                <span style="color:#4e9a06">&#34;  </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">record</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">,&#34;</span>
                <span style="color:#4e9a06">&#34;  </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">list</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">,&#34;</span>
                <span style="color:#4e9a06">&#34;  </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">fields</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: [&#34;</span>
                <span style="color:#4e9a06">&#34;    { </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">int</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06"> },&#34;</span>
                <span style="color:#4e9a06">&#34;    { </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">y</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">int</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06"> },&#34;</span>
                <span style="color:#4e9a06">&#34;    { </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">name</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">next</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">type</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: [</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">null</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">,</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">list</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">]}&#34;</span>
                <span style="color:#4e9a06">&#34;  ]&#34;</span>
                <span style="color:#4e9a06">&#34;}&#34;</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">rval</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_error_t</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_from_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">head</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_datum_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_record_set_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_record_set_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span>  <span style="color:#000">tail</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">avro_record_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;next&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_union_set_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tail</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_record_set_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;x&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_record_set_field_value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;y&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_record_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;next&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_union_set_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">head</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;nested record&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">head</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_enum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">avro_languages</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">AVRO_C</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">AVRO_CPP</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">AVRO_PYTHON</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">AVRO_RUBY</span><span style="color:#000;font-weight:bold">,</span>
                <span style="color:#000">AVRO_JAVA</span>
        <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_enum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;language&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_enum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AVRO_C</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_enum_symbol_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_enum_symbol_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C++&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_enum_symbol_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Python&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_enum_symbol_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Ruby&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_enum_symbol_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Java&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_enum_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">AVRO_C</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected enum value AVRO_C</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">strcmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_enum_get_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected enum value name C</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">C</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_enum_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AVRO_CPP</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">strcmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_enum_get_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;C++&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected enum value name C++</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">C++</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_enum_set_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Python&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_enum_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">AVRO_PYTHON</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected enum value AVRO_PYTHON</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Python</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rval</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_schema_int</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">i32_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">rval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_array_append_datum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i32_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i32_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rval</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_array_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected array size&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;array&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_schema_long</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">int64_t</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span>
            <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;zero&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;one&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;two&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;three&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;four&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;five&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;six&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span> <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">avro_datum_t</span> <span style="color:#000">i_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_map_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">i_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i_datum</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_array_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected map size</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">avro_datum_t</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_map_get_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_map_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">int64_t</span>  <span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_int64_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected map value 2</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_map_get_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;two&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Can&#39;t get index for key </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">two</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#000">avro_strerror</span><span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected index for key </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">two</span><span style="color:#4e9a06">\&#34;\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">avro_map_get_index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foobar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected index for key </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">foobar</span><span style="color:#4e9a06">\&#34;\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span>
                  <span style="color:#4e9a06">&#34;{</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">zero</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 0, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">one</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 1, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">two</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 2, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">three</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 3, &#34;</span>
                  <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">four</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 4, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">five</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 5, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">six</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: 6}&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_union</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_union</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">union_datum1</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum1</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">avro_schema_union_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_string</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000">avro_schema_union_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_int</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000">avro_schema_union_append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">avro_schema_null</span><span style="color:#000;font-weight:bold">());</span>

        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givestring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Follow your bliss.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">union_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_union</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_union_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected union discriminant</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">avro_union_current_branch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unexpected union branch datum</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">union_datum1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_datum_from_schema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_union_set_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">datum1</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_givestring_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Follow your bliss.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">avro_datum_equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum1</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Union values should be equal</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;union&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;{</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">string</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">Follow your bliss.</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">}&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_union_set_discriminant</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">union_datum1</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">test_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">0xD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xA</span> <span style="color:#000;font-weight:bold">};</span>
        <span style="color:#000">avro_schema_t</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_schema_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;msg&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">avro_datum_t</span> <span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givefixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">write_read_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">test_json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\&#34;\\</span><span style="color:#4e9a06">r</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">n</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">r</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">n</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">u000b</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">n</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">u000b</span><span style="color:#4e9a06">\\</span><span style="color:#4e9a06">n</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givefixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_givefixed_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">expected_datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_givefixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">avro_datum_equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#4e9a06">&#34;Expected equal fixed instances.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expected_datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">// The following should bork if we don&#39;t copy the fixed value
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// correctly (since we&#39;ll try to free a static string).
</span><span style="color:#8f5902;font-style:italic"></span>
        <span style="color:#000">datum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro_fixed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;original&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_fixed_set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;alsothis&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">avro_datum_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datum</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#000">avro_schema_decref</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">avro_set_allocator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">test_allocator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">avro_tests</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">avro_test</span> <span style="color:#000">func</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">tests</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_string</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_bytes</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_int32</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;long&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_int64</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;float&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_float</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;double&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_double</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;boolean&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_boolean</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_null</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_record</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;nested_record&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_nested_record</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_enum</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;array&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_array</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_map</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_fixed</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#4e9a06">&#34;union&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_union</span><span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">};</span>

        <span style="color:#000">init_rand</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tests</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tests</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">avro_tests</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tests</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;**** Running %s tests ****</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">test</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_SUCCESS</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>
</div>


  
  
  
  

  
  

  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:user@avro.apache.org" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/ApacheAvro" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/avro" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/apache/avro" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Chat with other project developers at Slack" aria-label="Chat with other project developers at Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://the-asf.slack.com/" aria-label="Chat with other project developers at Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:dev@avro.apache.org" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Apache Software Foundation All Rights Reserved</small>
	
      <p><small class="text-white">Apache, Avro and Hadoop are registered trademarks of the Apache Software Foundation in the United States and other countries.</small></p>
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




 














<script src="/js/main.min.da35b82a1ff45cca90044ed24861e456ad09e5523c8cfcdd66939e705b594419.js" integrity="sha256-2jW4Kh/0XMqQBE7SSGHkVq0J5VI8jPzdZpOecFtZRBk=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
