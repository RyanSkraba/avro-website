<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.80.0" /><link rel="canonical" type="text/html" href="/docs/mapreduce-guide/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/mapreduce-guide/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>MapReduce guide | Apache Avro</title>


  
  <meta name="description" content="Avro provides a convenient way to represent complex data structures within a Hadoop MapReduce job. Avro data can be used as both input to and output …">
<meta property="og:title" content="MapReduce guide" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/mapreduce-guide/" />
<meta property="og:site_name" content="Apache Avro" />
<meta itemprop="name" content="MapReduce guide">
<meta itemprop="description" content="">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MapReduce guide"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/scss/main.min.30d73e35c90f654c060d7e7add9a2e7c0ba6dad30372ff7416b222681b7b4652.css" as="style">
<link href="/scss/main.min.30d73e35c90f654c060d7e7add9a2e7c0ba6dad30372ff7416b222681b7b4652.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>









  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Apache Avro</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/project/" ><span>Project</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>Blog</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>Community</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.7843a0bb1ab5518e2ca0004c5f9dd340.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/mapreduce-guide/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">MapReduce guide</h1>





    <ul>
    
  
  
  
  

  

    </ul>


<div class="content">
      <p>Avro provides a convenient way to represent complex data structures within a Hadoop MapReduce job. Avro data can be used as both input to and output from a MapReduce job, as well as the intermediate format. The example in this guide uses Avro data for all three, but it&rsquo;s possible to mix and match; for instance, MapReduce can be used to aggregate a particular field in an Avro record.</p>
<p>This guide assumes basic familiarity with both Hadoop MapReduce and Avro. See the <a href="https://hadoop.apache.org/docs/current/">Hadoop documentation</a> and the <a href="./getting-started-java/">Avro getting started guide</a> for introductions to these projects. This guide uses the old MapReduce API (<code>org.apache.hadoop.mapred</code>) and the new MapReduce API (<code>org.apache.hadoop.mapreduce</code>).</p>
<h2 id="setup">Setup</h2>
<p>The code from this guide is included in the Avro docs under examples/mr-example. The example is set up as a Maven project that includes the necessary Avro and MapReduce dependencies and the Avro Maven plugin for code generation, so no external jars are needed to run the example. In particular, the POM includes the following dependencies:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.10.2<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-mapred<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.10.2<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.hadoop<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>hadoop-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>3.1.2<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</code></pre></div><p>And the following plugin:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;plugin&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-maven-plugin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.10.2<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;executions&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;execution&gt;</span>
      <span style="color:#204a87;font-weight:bold">&lt;phase&gt;</span>generate-sources<span style="color:#204a87;font-weight:bold">&lt;/phase&gt;</span>
      <span style="color:#204a87;font-weight:bold">&lt;goals&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;goal&gt;</span>schema<span style="color:#204a87;font-weight:bold">&lt;/goal&gt;</span>
      <span style="color:#204a87;font-weight:bold">&lt;/goals&gt;</span>
      <span style="color:#204a87;font-weight:bold">&lt;configuration&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;sourceDirectory&gt;</span>${project.basedir}/../<span style="color:#204a87;font-weight:bold">&lt;/sourceDirectory&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;outputDirectory&gt;</span>${project.basedir}/target/generated-sources/<span style="color:#204a87;font-weight:bold">&lt;/outputDirectory&gt;</span>
      <span style="color:#204a87;font-weight:bold">&lt;/configuration&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/execution&gt;</span>
  <span style="color:#204a87;font-weight:bold">&lt;/executions&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/plugin&gt;</span>
</code></pre></div><p>If you do not configure the <em>sourceDirectory</em> and <em>outputDirectory</em> properties, the defaults will be used. The <em>sourceDirectory</em> property defaults to <em>src/main/avro</em>. The <em>outputDirectory</em> property defaults to <em>target/generated-sources</em>. You can change the paths to match your project layout.</p>
<p>Alternatively, Avro jars can be downloaded directly from the Apache Avro™ Releases <a href="https://avro.apache.org/releases.html">page</a>. The relevant Avro jars for this guide are <em>avro-1.10.2.jar</em> and <em>avro-mapred-1.10.2.jar</em>, as well as <em>avro-tools-1.10.2.jar</em> for code generation and viewing Avro data files as JSON. In addition, you will need to install Hadoop in order to use MapReduce.</p>
<h2 id="example-colorcount">Example: ColorCount</h2>
<p>Below is a simple example of a MapReduce that uses Avro. There is an example for both the old (org.apache.hadoop.mapred) and new (org.apache.hadoop.mapreduce) APIs under <em>examples/mr-example/src/main/java/example/</em>. <em>MapredColorCount</em> is the example for the older mapred API while <em>MapReduceColorCount</em> is the example for the newer mapreduce API. Both examples are below, but we will detail the mapred API in our subsequent examples.</p>
<p>MapredColorCount.java:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.io.IOException</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.Schema.Type</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapred.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.conf.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.fs.Path</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapred.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.util.*</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">example.avro.User</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MapredColorCount</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Configured</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">Tool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroMapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
      <span style="color:#8f5902;font-style:italic">// We need this check because the User.favorite_color field has type [&#34;string&#34;, &#34;null&#34;]
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroReducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                            <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CharSequence</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
                       <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span>
                       <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Integer</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">2</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">err</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Usage: MapredColorCount &lt;input path&gt; &lt;output path&gt;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#000">JobConf</span> <span style="color:#000">conf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">JobConf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">getConf</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">MapredColorCount</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setJobName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;colorcount&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#000">FileInputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputPaths</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]));</span>
    <span style="color:#000">FileOutputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputPath</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">]));</span>

    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapperClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setReducerClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountReducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Note that AvroJob.setInputSchema and AvroJob.setOutputSchema set
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// relevant config options such as input/output format, map output
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// classes, and output key class.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getClassSchema</span><span style="color:#ce5c00;font-weight:bold">());</span>
    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPairSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STRING</span><span style="color:#ce5c00;font-weight:bold">),</span>
        <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">INT</span><span style="color:#ce5c00;font-weight:bold">)));</span>

    <span style="color:#000">JobClient</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runJob</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ToolRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Configuration</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MapredColorCount</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">exit</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>MapReduceColorCount.java:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.io.IOException</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.Schema</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapred.AvroKey</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapred.AvroValue</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapreduce.AvroJob</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapreduce.AvroKeyInputFormat</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapreduce.AvroKeyValueOutputFormat</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.conf.Configured</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.fs.Path</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.io.IntWritable</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.io.NullWritable</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.io.Text</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapreduce.Job</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapreduce.Mapper</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapreduce.Reducer</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapreduce.lib.input.FileInputFormat</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapreduce.lib.output.FileOutputFormat</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.util.Tool</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.util.ToolRunner</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">example.avro.User</span><span style="color:#ce5c00;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MapReduceColorCount</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Configured</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">Tool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span>
      <span style="color:#000">Mapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;,</span> <span style="color:#000">NullWritable</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">NullWritable</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Context</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterruptedException</span> <span style="color:#ce5c00;font-weight:bold">{</span>

      <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">datum</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">write</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">()),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span>
      <span style="color:#000">Reducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">&gt;,</span> <span style="color:#000">AvroValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Text</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
        <span style="color:#000">Context</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterruptedException</span> <span style="color:#ce5c00;font-weight:bold">{</span>

      <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IntWritable</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">();</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">write</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">()),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AvroValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">2</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">err</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Usage: MapReduceColorCount &lt;input path&gt; &lt;output path&gt;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#000">Job</span> <span style="color:#000">job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Job</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">getConf</span><span style="color:#ce5c00;font-weight:bold">());</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setJarByClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MapReduceColorCount</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setJobName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Color Count&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#000">FileInputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputPaths</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">]));</span>
    <span style="color:#000">FileOutputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputPath</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">]));</span>

    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputFormatClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AvroKeyInputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapperClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ColorCountMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputKeySchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getClassSchema</span><span style="color:#ce5c00;font-weight:bold">());</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapOutputKeyClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapOutputValueClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputFormatClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AvroKeyValueOutputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setReducerClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ColorCountReducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputKeySchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STRING</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputValueSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">INT</span><span style="color:#ce5c00;font-weight:bold">));</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">waitForCompletion</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">0</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ToolRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MapReduceColorCount</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">exit</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>ColorCount reads in data files containing <em>User</em> records, defined in <em>examples/user.avsc</em>, and counts the number of instances of each favorite color. (This example draws inspiration from the canonical <em>WordCount</em> MapReduce application.) This example uses the old MapReduce API. See MapReduceAvroWordCount, found under <em>doc/examples/mr-example/src/main/java/example/</em> to see the new MapReduce API example. The User schema is defined as follows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example.avro&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">},</span>
     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]},</span>
     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]}</span>
 <span style="color:#000;font-weight:bold">]</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>This schema is compiled into the <em>User</em> class used by <em>ColorCount</em> via the Avro Maven plugin (see <em>examples/mr-example/pom.xml</em> for how this is set up).</p>
<p><em>ColorCountMapper</em> essentially takes a <em>User</em> as input and extracts the User&rsquo;s favorite color, emitting the key-value pair <code>&lt;favoriteColor, 1&gt;</code>. <em>ColorCountReducer</em> then adds up how many occurrences of a particular favorite color were emitted, and outputs the result as a Pair record. These Pairs are serialized to an Avro data file.</p>
<h2 id="running-colorcount">Running ColorCount</h2>
<p>The <em>ColorCount</em> application is provided as a Maven project in the Avro docs under <em>examples/mr-example</em>. To build the project, including the code generation of the User schema, run:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mvn compile
</code></pre></div><p>Next, run <em>GenerateData</em> from <code>examples/mr-examples</code> to create an Avro data file, <code>input/users.avro</code>, containing 20 Users with favorite colors chosen randomly from a list:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mvn exec:java -q -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.GenerateData
</code></pre></div><p>Besides creating the data file, GenerateData prints the JSON representations of the Users generated to stdout, for example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;green&#34;</span><span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;purple&#34;</span><span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">}</span>
<span style="color:#a40000">...</span>
</code></pre></div><p>Now we&rsquo;re ready to run ColorCount. We specify our freshly-generated input folder as the input path and output as our output folder (note that MapReduce will not start a job if the output folder already exists):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mvn exec:java -q -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.MapredColorCount -Dexec.args<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;input output&#34;</span>
</code></pre></div><p>Once ColorCount completes, checking the contents of the new output directory should yield the following:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ls output/
part-00000.avro  _SUCCESS
</code></pre></div><p>You can check the contents of the generated Avro file using the avro-tools jar:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ java -jar /path/to/avro-tools-1.10.2.jar tojson output/part-00000.avro
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 3, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 7, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;green&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 1, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;orange&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 3, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;purple&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;yellow&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>Now let&rsquo;s go over the ColorCount example in detail.</p>
<h2 id="avromapper---orgapachehadoopmapred-api">AvroMapper - org.apache.hadoop.mapred API</h2>
<p>The easiest way to use Avro data files as input to a MapReduce job is to subclass <code>AvroMapper</code>. An <code>AvroMapper</code> defines a <code>map</code> function that takes an Avro datum as input and outputs a key/value pair represented as a Pair record. In the ColorCount example, ColorCountMapper is an AvroMapper that takes a User as input and outputs a <code>Pair&lt;CharSequence, Integer&gt;&gt;</code>, where the CharSequence key is the user&rsquo;s favorite color and the Integer value is 1.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroMapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#5c35cc;font-weight:bold">@Override</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
      <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
    <span style="color:#8f5902;font-style:italic">// We need this check because the User.favorite_color field has type [&#34;string&#34;, &#34;null&#34;]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>In order to use our AvroMapper, we must call AvroJob.setMapperClass and AvroJob.setInputSchema.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapperClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getClassSchema</span><span style="color:#ce5c00;font-weight:bold">());</span>
</code></pre></div><p>Note that <code>AvroMapper</code> does not implement the <code>Mapper</code> interface. Under the hood, the specified Avro data files are deserialized into AvroWrappers containing the actual data, which are processed by a Mapper that calls the configured AvroMapper&rsquo;s map function. AvroJob.setInputSchema sets up the relevant configuration parameters needed to make this happen, thus you should not need to call <code>JobConf.setMapperClass</code>, <code>JobConf.setInputFormat</code>, <code>JobConf.setMapOutputKeyClass</code>, <code>JobConf.setMapOutputValueClass</code>, or <code>JobConf.setOutputKeyComparatorClass</code>.</p>
<h2 id="mapper---orgapachehadoopmapreduce-api">Mapper - org.apache.hadoop.mapreduce API</h2>
<p>This document will not go into all the differences between the mapred and mapreduce APIs, however will describe the main differences. As you can see, ColorCountMapper is now a subclass of the Hadoop Mapper class and is passed an AvroKey as it&rsquo;s key. Additionally, the AvroJob method calls were slightly changed.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span>
      <span style="color:#000">Mapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;,</span> <span style="color:#000">NullWritable</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">NullWritable</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Context</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterruptedException</span> <span style="color:#ce5c00;font-weight:bold">{</span>

      <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">datum</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">write</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">()),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="avroreducer---orgapachehadoopmapred-api">AvroReducer - org.apache.hadoop.mapred API</h2>
<p>Analogously to AvroMapper, an AvroReducer defines a reducer function that takes the key/value types output by an AvroMapper (or any mapper that outputs Pairs) and outputs a key/value pair represented a Pair record. In the ColorCount example, ColorCountReducer is an AvroReducer that takes the CharSequence key representing a favorite color and the <code>Iterable&lt;Integer&gt;</code> representing the counts for that color (they should all be 1 in this example) and adds up the counts.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroReducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">,</span>
                                                          <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
  <span style="color:#5c35cc;font-weight:bold">@Override</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CharSequence</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
                     <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span>
                     <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
      <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Integer</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>In order to use our AvroReducer, we must call AvroJob.setReducerClass and AvroJob.setOutputSchema.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setReducerClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountReducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPairSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STRING</span><span style="color:#ce5c00;font-weight:bold">),</span>
                                                 <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">INT</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</code></pre></div><p>Note that <em>AvroReducer</em> does not implement the <em>Reducer</em> interface. The intermediate Pairs output by the mapper are split into <em>AvroKeys</em> and <em>AvroValues</em>, which are processed by a Reducer that calls the configured AvroReducer&rsquo;s <code>reduce</code> function. <code>AvroJob.setOutputSchema</code> sets up the relevant configuration parameters needed to make this happen, thus you should not need to call <code>JobConf.setReducerClass</code>, <code>JobConf.setOutputFormat</code>, <code>JobConf.setOutputKeyClass</code>, <code>JobConf.setMapOutputKeyClass</code>, <code>JobConf.setMapOutputValueClass</code>, or <code>JobConf.setOutputKeyComparatorClass</code>.</p>
<h2 id="reduce---orgapachehadoopmapreduce-api">Reduce - org.apache.hadoop.mapreduce API</h2>
<p>As before we not detail every difference between the APIs. As with the <em>Mapper</em> change <em>ColorCountReducer</em> is now a subclass of <em>Reducer</em> and <em>AvroKey</em> and <em>AvroValue</em> are emitted. Additionally, the <em>AvroJob</em> method calls were slightly changed.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span>
      <span style="color:#000">Reducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Text</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">&gt;,</span> <span style="color:#000">AvroValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#5c35cc;font-weight:bold">@Override</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Text</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">IntWritable</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
        <span style="color:#000">Context</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">InterruptedException</span> <span style="color:#ce5c00;font-weight:bold">{</span>

      <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IntWritable</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">();</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
      <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">write</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AvroKey</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">()),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AvroValue</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h2 id="learning-more">Learning more</h2>
<p>The mapred API allows users to mix Avro AvroMappers and AvroReducers with non-Avro Mappers and Reducers and the mapreduce API allows users input Avro and output non-Avro or vice versa.</p>
<p>The mapred package has API org.apache.avro.mapred documentation as does the <code>org.apache.avro.mapreduce</code> package. MapReduce API (<code>org.apache.hadoop.mapreduce</code>). Similarily to the mapreduce package, it&rsquo;s possible with the mapred API to implement your own Mappers and Reducers directly using the public classes provided in these libraries. See the <code>AvroWordCount</code> application, found under <em>examples/mr-example/src/main/java/example/AvroWordCount.java</em> in the Avro documentation, for an example of implementing a Reducer that outputs Avro data using the old MapReduce API. See the <code>MapReduceAvroWordCount</code> application, found under <em>examples/mr-example/src/main/java/example/MapReduceAvroWordCount.java</em> in the Avro documentation, for an example of implementing a Reducer that outputs Avro data using the new MapReduce API.</p>

</div>
</div>


  
  
  
  

  
  

  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:user@avro.apache.org" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/ApacheAvro" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/avro" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/apache/avro" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Chat with other project developers at Slack" aria-label="Chat with other project developers at Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://the-asf.slack.com/" aria-label="Chat with other project developers at Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:dev@avro.apache.org" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Apache Software Foundation All Rights Reserved</small>
	
      <p><small class="text-white">Apache, Avro and Hadoop are registered trademarks of the Apache Software Foundation in the United States and other countries.</small></p>
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




 














<script src="/js/main.min.da35b82a1ff45cca90044ed24861e456ad09e5523c8cfcdd66939e705b594419.js" integrity="sha256-2jW4Kh/0XMqQBE7SSGHkVq0J5VI8jPzdZpOecFtZRBk=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
